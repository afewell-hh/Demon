{% extends "base.html" %}

{% block title %}Graph Viewer - Demon Operate UI{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Graph Viewer</h2>
    </div>

    <div style="margin-bottom: 1.5rem;">
        <form id="scopeForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <label for="tenantId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tenant ID:</label>
                <input type="text" id="tenantId" name="tenantId" value="{{ tenant_id }}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            <div>
                <label for="projectId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Project ID:</label>
                <input type="text" id="projectId" name="projectId" value="{{ project_id }}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            <div>
                <label for="namespace" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Namespace:</label>
                <input type="text" id="namespace" name="namespace" value="{{ namespace }}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            <div>
                <label for="graphId" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Graph ID:</label>
                <input type="text" id="graphId" name="graphId" value="{{ graph_id }}"
                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            <div style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Load Graph</button>
            </div>
        </form>
    </div>

    <div id="loadingIndicator" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
        <p>Loading graph data...</p>
    </div>

    <div id="errorDisplay" style="display: none;" class="alert alert-error"></div>
</div>

<div class="card" id="tagsCard" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Tags</h3>
    </div>
    <div id="tagsContainer"></div>
</div>

<div class="card" id="commitsCard" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Recent Commits</h3>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="text" id="commitFilter" placeholder="Filter commits..."
                   style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <select id="mutationTypeFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
                <option value="">All Mutations</option>
                <option value="add-node">Add Node</option>
                <option value="add-edge">Add Edge</option>
                <option value="update-node">Update Node</option>
                <option value="delete-node">Delete Node</option>
                <option value="delete-edge">Delete Edge</option>
            </select>
        </div>
    </div>
    <div id="commitsContainer"></div>
</div>

<div class="card" id="dagCard" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Commit DAG</h3>
        <button id="toggleDagBtn" class="btn btn-secondary">Show DAG</button>
    </div>
    <div id="dagContainer" style="display: none; padding: 1rem; background: #f9f9f9; border-radius: 4px; overflow-x: auto;">
        <svg id="dagSvg" width="100%" height="400"></svg>
    </div>
</div>

<div class="card" id="commitDetailCard" style="display: none;">
    <div class="card-header">
        <h3 class="card-title">Commit Detail</h3>
        <button id="closeDetailBtn" class="btn btn-secondary">Close</button>
    </div>
    <div id="commitDetailContainer"></div>
</div>

{% if rendered_cards %}
<div class="card" id="runCardsPanel">
    <div class="card-header">
        <h3 class="card-title">Run Cards - {{ run_id }}</h3>
        <a href="/runs/{{ run_id }}" class="btn btn-secondary" style="margin-left: auto; margin-right: 0.5rem;">View Run Detail</a>
    </div>
    <div style="margin-bottom: 1rem; padding: 0 1rem;">
        <p><strong>Run ID:</strong> <code>{{ run_id }}</code></p>
        <p><strong>Ritual:</strong> <code>{{ run_ritual_id }}</code></p>
    </div>
    <div class="app-pack-cards-container" style="padding: 0 1rem;">
        {% for card in rendered_cards %}
        <div class="app-pack-card" data-card-id="{{ card.id }}" data-card-kind="{{ card.kind }}" style="margin-bottom: 1rem;">
            <div class="app-pack-card-header">
                <h4 class="app-pack-card-title">{{ card.title }}</h4>
                <span class="card-kind-badge">{{ card.kind }}</span>
            </div>
            {% if card.description %}
            <p class="app-pack-card-description">{{ card.description }}</p>
            {% endif %}
            <div class="app-pack-card-content">
                {{ card.html | safe }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
const RUNTIME_API_URL = "{{ runtime_api_url }}";

let currentScope = {
    tenantId: "{{ tenant_id }}",
    projectId: "{{ project_id }}",
    namespace: "{{ namespace }}",
    graphId: "{{ graph_id }}"
};

let allCommits = [];
let allTags = [];

document.getElementById('scopeForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    disconnectSSE();

    currentScope = {
        tenantId: document.getElementById('tenantId').value,
        projectId: document.getElementById('projectId').value,
        namespace: document.getElementById('namespace').value,
        graphId: document.getElementById('graphId').value
    };

    await loadGraphData();
    connectSSE();
});

document.getElementById('closeDetailBtn').addEventListener('click', () => {
    document.getElementById('commitDetailCard').style.display = 'none';
});

document.getElementById('toggleDagBtn').addEventListener('click', () => {
    const dagContainer = document.getElementById('dagContainer');
    const toggleBtn = document.getElementById('toggleDagBtn');

    if (dagContainer.style.display === 'none') {
        dagContainer.style.display = 'block';
        toggleBtn.textContent = 'Hide DAG';
        renderDAG(allCommits);
    } else {
        dagContainer.style.display = 'none';
        toggleBtn.textContent = 'Show DAG';
    }
});

document.getElementById('commitFilter').addEventListener('input', (e) => {
    applyFilters();
});

document.getElementById('mutationTypeFilter').addEventListener('change', (e) => {
    applyFilters();
});

function applyFilters() {
    const searchText = document.getElementById('commitFilter').value.toLowerCase();
    const mutationType = document.getElementById('mutationTypeFilter').value;

    let filtered = allCommits.filter(commit => {
        // Text search
        const matchesSearch = !searchText ||
            commit.commitId.toLowerCase().includes(searchText) ||
            (commit.parentCommitId && commit.parentCommitId.toLowerCase().includes(searchText));

        // Mutation type filter
        const matchesMutation = !mutationType ||
            (commit.mutations && commit.mutations.some(m => m.op === mutationType));

        return matchesSearch && matchesMutation;
    });

    displayCommits(filtered);
}

async function loadGraphData() {
    showLoading(true);
    hideError();

    try {
        // Load tags and commits in parallel
        const [tags, commits] = await Promise.all([
            fetchTags(),
            fetchCommits()
        ]);

        allTags = tags;
        allCommits = commits;

        displayTags(tags);
        displayCommits(commits);

        // Show DAG card if we have commits
        if (commits.length > 0) {
            document.getElementById('dagCard').style.display = 'block';
        }

        showLoading(false);
    } catch (err) {
        showLoading(false);
        showError(err.message || 'Failed to load graph data');
    }
}

async function fetchTags() {
    const params = new URLSearchParams(currentScope);
    const url = `${RUNTIME_API_URL}/api/graph/tags?${params}`;

    const response = await fetch(url);
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    return await response.json();
}

async function fetchCommits(limit = 50) {
    const params = new URLSearchParams({ ...currentScope, limit: limit.toString() });
    const url = `${RUNTIME_API_URL}/api/graph/commits?${params}`;

    const response = await fetch(url);
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    return await response.json();
}

async function fetchCommitDetail(commitId) {
    const params = new URLSearchParams(currentScope);
    const url = `${RUNTIME_API_URL}/api/graph/commits/${commitId}?${params}`;

    const response = await fetch(url);
    if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    return await response.json();
}

function displayTags(tags) {
    const container = document.getElementById('tagsContainer');
    const card = document.getElementById('tagsCard');

    if (!tags || tags.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No tags found</p></div>';
        card.style.display = 'block';
        return;
    }

    let html = '<table class="table"><thead><tr><th>Tag</th><th>Commit ID</th><th>Timestamp</th><th>Actions</th></tr></thead><tbody>';

    for (const tag of tags) {
        const shortCommit = tag.commitId.substring(0, 12);
        const ts = new Date(tag.timestamp).toLocaleString();
        html += `
            <tr>
                <td><strong>${escapeHtml(tag.tag)}</strong></td>
                <td><code>${escapeHtml(shortCommit)}</code></td>
                <td>${escapeHtml(ts)}</td>
                <td><a href="#" onclick="viewCommit('${escapeHtml(tag.commitId)}'); return false;">View</a></td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
    card.style.display = 'block';
}

function displayCommits(commits) {
    const container = document.getElementById('commitsContainer');
    const card = document.getElementById('commitsCard');

    if (!commits || commits.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No commits found</p></div>';
        card.style.display = 'block';
        return;
    }

    let html = '<table class="table"><thead><tr><th>Commit ID</th><th>Parent</th><th>Timestamp</th><th>Mutations</th><th>Actions</th></tr></thead><tbody>';

    for (const commit of commits) {
        const shortCommit = commit.commitId.substring(0, 12);
        const shortParent = commit.parentCommitId ? commit.parentCommitId.substring(0, 12) : 'N/A';
        const ts = new Date(commit.ts).toLocaleString();
        const mutCount = commit.mutationsCount || commit.mutations?.length || 0;

        html += `
            <tr>
                <td><code>${escapeHtml(shortCommit)}</code></td>
                <td><code>${escapeHtml(shortParent)}</code></td>
                <td>${escapeHtml(ts)}</td>
                <td>${mutCount}</td>
                <td><a href="#" onclick="viewCommit('${escapeHtml(commit.commitId)}'); return false;">View</a></td>
            </tr>
        `;
    }

    html += '</tbody></table>';
    container.innerHTML = html;
    card.style.display = 'block';
}

async function viewCommit(commitId) {
    try {
        showLoading(true);
        const commit = await fetchCommitDetail(commitId);
        showLoading(false);

        const container = document.getElementById('commitDetailContainer');
        const card = document.getElementById('commitDetailCard');

        let html = `
            <div style="margin-bottom: 1rem;">
                <p><strong>Commit ID:</strong> <code>${escapeHtml(commit.commitId)}</code></p>
                <p><strong>Parent Commit:</strong> <code>${escapeHtml(commit.parentCommitId || 'N/A')}</code></p>
                <p><strong>Timestamp:</strong> ${escapeHtml(new Date(commit.ts).toLocaleString())}</p>
                <p><strong>Event:</strong> ${escapeHtml(commit.event)}</p>
            </div>
            <h4 style="margin-top: 1.5rem; margin-bottom: 0.5rem;">Mutations</h4>
        `;

        if (commit.mutations && commit.mutations.length > 0) {
            html += '<pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; max-height: 500px;">';
            html += escapeHtml(JSON.stringify(commit.mutations, null, 2));
            html += '</pre>';
        } else {
            html += '<p>No mutations in this commit</p>';
        }

        container.innerHTML = html;
        card.style.display = 'block';
        card.scrollIntoView({ behavior: 'smooth' });
    } catch (err) {
        showLoading(false);
        showError('Failed to load commit detail: ' + (err.message || 'Unknown error'));
    }
}

function showLoading(show) {
    document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorDisplay');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('errorDisplay').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function renderDAG(commits) {
    const svg = document.getElementById('dagSvg');
    if (!commits || commits.length === 0) {
        svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#666">No commits to display</text>';
        return;
    }

    // Build parent-child map
    const commitMap = new Map();
    commits.forEach(c => commitMap.set(c.commitId, c));

    // Simple linear layout (newest to oldest, left to right)
    const nodeWidth = 100;
    const nodeHeight = 40;
    const horizontalSpacing = 120;
    const verticalSpacing = 60;

    // Sort commits by timestamp (newest first)
    const sortedCommits = [...commits].sort((a, b) => new Date(b.ts) - new Date(a.ts));

    let svgContent = '';
    const positions = new Map();

    // Position nodes
    sortedCommits.forEach((commit, idx) => {
        const x = 50 + idx * horizontalSpacing;
        const y = 100;
        positions.set(commit.commitId, { x, y });

        const shortId = commit.commitId.substring(0, 8);
        const mutCount = commit.mutationsCount || commit.mutations?.length || 0;

        // Draw node
        svgContent += `
            <g class="commit-node" data-commit-id="${commit.commitId}" style="cursor: pointer;">
                <rect x="${x}" y="${y}" width="${nodeWidth}" height="${nodeHeight}"
                      rx="4" fill="#4CAF50" stroke="#388E3C" stroke-width="2"/>
                <text x="${x + nodeWidth/2}" y="${y + 20}" text-anchor="middle" fill="white" font-size="12" font-weight="bold">
                    ${shortId}
                </text>
                <text x="${x + nodeWidth/2}" y="${y + 35}" text-anchor="middle" fill="white" font-size="10">
                    ${mutCount} mut
                </text>
            </g>
        `;
    });

    // Draw edges (parent links)
    sortedCommits.forEach(commit => {
        if (commit.parentCommitId) {
            const parentPos = positions.get(commit.parentCommitId);
            const childPos = positions.get(commit.commitId);

            if (parentPos && childPos) {
                const x1 = childPos.x + nodeWidth;
                const y1 = childPos.y + nodeHeight / 2;
                const x2 = parentPos.x;
                const y2 = parentPos.y + nodeHeight / 2;

                svgContent += `
                    <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"
                          stroke="#666" stroke-width="2" marker-end="url(#arrowhead)"/>
                `;
            }
        }
    });

    // Arrow marker definition
    const defs = `
        <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#666" />
            </marker>
        </defs>
    `;

    svg.innerHTML = defs + svgContent;

    // Add click handlers
    svg.querySelectorAll('.commit-node').forEach(node => {
        node.addEventListener('click', () => {
            const commitId = node.getAttribute('data-commit-id');
            viewCommit(commitId);
        });
    });

    // Adjust SVG width based on number of commits
    const totalWidth = Math.max(800, 100 + sortedCommits.length * horizontalSpacing);
    svg.setAttribute('width', totalWidth);
}

// SSE connection for live updates
let sseConnection = null;
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

function connectSSE() {
    if (!currentScope.tenantId || !currentScope.projectId || !currentScope.namespace || !currentScope.graphId) {
        return;
    }

    const params = new URLSearchParams(currentScope);
    const url = `${RUNTIME_API_URL}/api/graph/events/stream?${params}`;

    try {
        sseConnection = new EventSource(url);

        sseConnection.onopen = () => {
            console.log('SSE connection opened');
            reconnectAttempts = 0;
        };

        sseConnection.addEventListener('graph.commit.created', (event) => {
            try {
                const commit = JSON.parse(event.data);
                console.log('New commit received:', commit);
                // Refresh commits list
                refreshCommits();
            } catch (err) {
                console.error('Failed to parse commit event:', err);
            }
        });

        sseConnection.addEventListener('graph.tag.created', (event) => {
            try {
                const tag = JSON.parse(event.data);
                console.log('New tag received:', tag);
                // Refresh tags list
                refreshTags();
            } catch (err) {
                console.error('Failed to parse tag event:', err);
            }
        });

        sseConnection.onerror = (err) => {
            console.error('SSE connection error:', err);
            sseConnection.close();

            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                setTimeout(connectSSE, delay);
            }
        };
    } catch (err) {
        console.error('Failed to create SSE connection:', err);
    }
}

function disconnectSSE() {
    if (sseConnection) {
        sseConnection.close();
        sseConnection = null;
    }
}

async function refreshCommits() {
    try {
        const commits = await fetchCommits();
        allCommits = commits;
        applyFilters(); // Re-apply current filters
        if (document.getElementById('dagContainer').style.display !== 'none') {
            renderDAG(allCommits);
        }
    } catch (err) {
        console.error('Failed to refresh commits:', err);
    }
}

async function refreshTags() {
    try {
        const tags = await fetchTags();
        allTags = tags;
        displayTags(tags);
    } catch (err) {
        console.error('Failed to refresh tags:', err);
    }
}

// Load data on page load and connect SSE
window.addEventListener('DOMContentLoaded', () => {
    loadGraphData().then(() => {
        connectSSE();
    });
});

// Clean up SSE on page unload
window.addEventListener('beforeunload', () => {
    disconnectSSE();
});
</script>
{% endblock %}

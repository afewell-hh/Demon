{% extends "base.html" %}

{% block title %}Contracts Browser - Demon Operate UI{% endblock %}

{% block content %}
<style>
    .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .search-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 1rem;
    }

    .filter-tags {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.75rem;
        background: #e3f2fd;
        color: #1565c0;
        border-radius: 16px;
        font-size: 0.875rem;
    }

    .filter-tag button {
        background: none;
        border: none;
        color: inherit;
        cursor: pointer;
        padding: 0;
        margin: 0;
        font-size: 1.2em;
    }

    .contracts-table-wrapper {
        overflow-x: auto;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .detail-drawer {
        position: fixed;
        top: 0;
        right: -600px;
        width: 600px;
        height: 100vh;
        background: var(--card-background);
        box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
        padding: 2rem;
    }

    .detail-drawer.open {
        right: 0;
    }

    .drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
        z-index: 999;
    }

    .drawer-overlay.visible {
        opacity: 1;
        visibility: visible;
    }

    .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .drawer-header h2 {
        font-size: 1.5rem;
        color: var(--text-primary);
    }

    .close-drawer {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        color: var(--text-secondary);
    }

    .close-drawer:hover {
        color: var(--text-primary);
    }

    .schema-preview {
        background: #f5f5f5;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
    }

    .expand-toggle {
        color: var(--primary-color);
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        display: inline-block;
    }

    .metadata-grid {
        display: grid;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .metadata-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .metadata-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metadata-value {
        color: var(--text-primary);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-top: 1.5rem;
    }
</style>

<div class="card">
    <div class="card-header">
        <h1 class="card-title">Contracts Browser</h1>
        <span id="contract-count" class="status-indicator status-info" style="background: #e3f2fd; color: #1565c0;">
            Loading...
        </span>
    </div>

    <div class="search-bar">
        <input
            type="text"
            id="search-input"
            class="search-input"
            placeholder="Search contracts by name, version, or author..."
            value="{% if search %}{{ search }}{% endif %}"
        >
    </div>

    <div id="filter-tags" class="filter-tags" style="display: none;">
        <!-- Dynamic filter tags will be inserted here -->
    </div>

    <div id="loading-state" class="empty-state">
        <div class="loading-spinner"></div>
        <p>Loading contracts from schema registry...</p>
    </div>

    <div id="error-state" class="alert alert-error" style="display: none;">
        <strong>Error:</strong> <span id="error-message"></span>
    </div>

    <div id="empty-state" class="empty-state" style="display: none;">
        <h3>No contracts found</h3>
        <p>The schema registry is empty or no contracts match your search criteria.</p>
    </div>

    <div id="contracts-container" class="contracts-table-wrapper" style="display: none;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Version</th>
                    <th>Author</th>
                    <th>Created</th>
                    <th>Digest</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="contracts-tbody">
                <!-- Contracts will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Detail Drawer -->
<div class="drawer-overlay" id="drawer-overlay"></div>
<div class="detail-drawer" id="detail-drawer">
    <div class="drawer-header">
        <h2 id="drawer-title">Contract Details</h2>
        <button class="close-drawer" id="close-drawer" aria-label="Close">&times;</button>
    </div>

    <div id="drawer-content">
        <div class="loading-spinner"></div>
        <p>Loading contract details...</p>
    </div>
</div>

<script>
(function() {
    'use strict';

    let allContracts = [];
    let filteredContracts = [];
    let currentSearch = '';

    const elements = {
        searchInput: document.getElementById('search-input'),
        contractsContainer: document.getElementById('contracts-container'),
        contractsTbody: document.getElementById('contracts-tbody'),
        loadingState: document.getElementById('loading-state'),
        errorState: document.getElementById('error-state'),
        emptyState: document.getElementById('empty-state'),
        errorMessage: document.getElementById('error-message'),
        contractCount: document.getElementById('contract-count'),
        drawerOverlay: document.getElementById('drawer-overlay'),
        detailDrawer: document.getElementById('detail-drawer'),
        closeDrawer: document.getElementById('close-drawer'),
        drawerTitle: document.getElementById('drawer-title'),
        drawerContent: document.getElementById('drawer-content'),
    };

    // Initialize
    async function init() {
        await loadContracts();
        setupEventListeners();
    }

    function setupEventListeners() {
        // Search input with debounce
        let searchTimeout;
        elements.searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = e.target.value.toLowerCase().trim();
                filterAndRenderContracts();
            }, 300);
        });

        // Drawer close handlers
        elements.closeDrawer.addEventListener('click', closeDrawer);
        elements.drawerOverlay.addEventListener('click', closeDrawer);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDrawer();
            }
        });
    }

    async function loadContracts() {
        try {
            showLoading();

            const response = await fetch('/api/contracts/registry/list');

            if (!response.ok) {
                throw new Error(`Failed to fetch contracts: ${response.statusText}`);
            }

            const data = await response.json();
            allContracts = data.contracts || [];

            filterAndRenderContracts();
        } catch (error) {
            console.error('Error loading contracts:', error);
            showError(error.message);
        }
    }

    function filterAndRenderContracts() {
        filteredContracts = allContracts.filter(contract => {
            if (!currentSearch) return true;

            const searchable = [
                contract.name || '',
                contract.version || '',
                contract.author || '',
                contract.description || ''
            ].join(' ').toLowerCase();

            return searchable.includes(currentSearch);
        });

        if (filteredContracts.length === 0 && allContracts.length > 0) {
            showEmpty();
        } else if (filteredContracts.length === 0) {
            showEmpty();
        } else {
            renderContracts();
        }
    }

    function renderContracts() {
        elements.contractsTbody.innerHTML = '';

        filteredContracts.forEach(contract => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${escapeHtml(contract.name || 'Unknown')}</strong></td>
                <td><code>${escapeHtml(contract.version || '0.0.0')}</code></td>
                <td>${escapeHtml(contract.author || 'Unknown')}</td>
                <td>${formatDate(contract.created_at || contract.createdAt)}</td>
                <td><code style="font-size: 0.75rem;">${truncateDigest(contract.digest || '')}</code></td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="window.contractsApp.viewDetails('${escapeHtml(contract.name)}', '${escapeHtml(contract.version)}')">
                        View
                    </button>
                </td>
            `;
            elements.contractsTbody.appendChild(row);
        });

        elements.contractCount.textContent = `${filteredContracts.length} contract${filteredContracts.length !== 1 ? 's' : ''}`;
        elements.contractCount.className = 'status-indicator status-completed';

        hideAll();
        elements.contractsContainer.style.display = 'block';
    }

    async function viewDetails(name, version) {
        openDrawer();
        elements.drawerTitle.textContent = `${name} v${version}`;
        elements.drawerContent.innerHTML = '<div class="loading-spinner"></div><p>Loading contract details...</p>';

        try {
            const response = await fetch(`/api/contracts/registry/${encodeURIComponent(name)}/${encodeURIComponent(version)}`);

            if (!response.ok) {
                throw new Error('Contract not found');
            }

            const contract = await response.json();
            renderContractDetails(contract);
        } catch (error) {
            console.error('Error loading contract details:', error);
            elements.drawerContent.innerHTML = `
                <div class="alert alert-error">
                    <strong>Error:</strong> ${escapeHtml(error.message)}
                </div>
            `;
        }
    }

    function renderContractDetails(contract) {
        const schema = contract.jsonSchema || contract.json_schema || '{}';
        const schemaPreview = typeof schema === 'string' ? schema : JSON.stringify(schema, null, 2);
        const previewLines = schemaPreview.split('\n').slice(0, 40);
        const hasMore = schemaPreview.split('\n').length > 40;

        elements.drawerContent.innerHTML = `
            <div class="metadata-grid">
                <div class="metadata-item">
                    <span class="metadata-label">Name</span>
                    <span class="metadata-value">${escapeHtml(contract.name)}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Version</span>
                    <span class="metadata-value">${escapeHtml(contract.version)}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Author</span>
                    <span class="metadata-value">${escapeHtml(contract.author || 'Unknown')}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Created</span>
                    <span class="metadata-value">${formatDate(contract.created_at || contract.createdAt)}</span>
                </div>
                <div class="metadata-item">
                    <span class="metadata-label">Digest</span>
                    <span class="metadata-value"><code style="font-size: 0.75rem; word-break: break-all;">${escapeHtml(contract.digest || 'N/A')}</code></span>
                </div>
                ${contract.description ? `
                <div class="metadata-item">
                    <span class="metadata-label">Description</span>
                    <span class="metadata-value">${escapeHtml(contract.description)}</span>
                </div>
                ` : ''}
            </div>

            <h3 style="margin-bottom: 1rem;">JSON Schema</h3>
            <div class="schema-preview" id="schema-preview">${escapeHtml(previewLines.join('\n'))}</div>
            ${hasMore ? '<span class="expand-toggle" id="expand-toggle">Show full schema...</span>' : ''}

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="window.contractsApp.downloadContract('${escapeHtml(contract.name)}', '${escapeHtml(contract.version)}')">
                    Download Schema
                </button>
            </div>
        `;

        if (hasMore) {
            const expandToggle = document.getElementById('expand-toggle');
            const schemaPreviewEl = document.getElementById('schema-preview');
            let expanded = false;

            expandToggle.addEventListener('click', () => {
                if (expanded) {
                    schemaPreviewEl.textContent = previewLines.join('\n');
                    expandToggle.textContent = 'Show full schema...';
                } else {
                    schemaPreviewEl.textContent = schemaPreview;
                    expandToggle.textContent = 'Show less';
                }
                expanded = !expanded;
            });
        }
    }

    function downloadContract(name, version) {
        const blob = new Blob([JSON.stringify({ name, version }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}-${version}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function openDrawer() {
        elements.detailDrawer.classList.add('open');
        elements.drawerOverlay.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }

    function closeDrawer() {
        elements.detailDrawer.classList.remove('open');
        elements.drawerOverlay.classList.remove('visible');
        document.body.style.overflow = '';
    }

    function showLoading() {
        hideAll();
        elements.loadingState.style.display = 'block';
    }

    function showError(message) {
        hideAll();
        elements.errorMessage.textContent = message;
        elements.errorState.style.display = 'block';
    }

    function showEmpty() {
        hideAll();
        elements.emptyState.style.display = 'block';
        elements.contractCount.textContent = '0 contracts';
        elements.contractCount.className = 'status-indicator status-warning';
    }

    function hideAll() {
        elements.loadingState.style.display = 'none';
        elements.errorState.style.display = 'none';
        elements.emptyState.style.display = 'none';
        elements.contractsContainer.style.display = 'none';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'Unknown';
        try {
            return new Date(dateStr).toLocaleString();
        } catch {
            return dateStr;
        }
    }

    function truncateDigest(digest) {
        if (!digest) return 'N/A';
        return digest.length > 16 ? digest.substring(0, 16) + '...' : digest;
    }

    // Expose API for onclick handlers
    window.contractsApp = {
        viewDetails,
        downloadContract
    };

    // Initialize on load
    init();
})();
</script>
{% endblock %}

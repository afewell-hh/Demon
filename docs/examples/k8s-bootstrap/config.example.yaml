# Example Kubernetes Bootstrap Configuration
# This file demonstrates how to configure a Demon Kubernetes deployment

apiVersion: demon.io/v1
kind: BootstrapConfig
metadata:
  name: my-demon-cluster

# Kubernetes cluster configuration
cluster:
  name: my-k3s-cluster
  runtime: k3s
  k3s:
    version: "v1.28.2+k3s1"  # K3s version to install
    install:
      channel: stable
      disable: []
    dataDir: /var/lib/rancher/k3s  # K3s data directory
    nodeName: demon-node-1  # Name for the cluster node
    extraArgs:
      - "--disable=traefik"  # Disable default traefik ingress
      - "--disable=servicelb"  # Disable service load balancer

# Demon system configuration
demon:
  # NATS connection settings
  natsUrl: "nats://nats.demon-system.svc.cluster.local:4222"
  streamName: "RITUAL_EVENTS"
  subjects:
    - "ritual.>"
    - "approval.>"
  dedupeWindowSecs: 60

  # UI configuration
  uiUrl: "http://operate-ui.demon-system.svc.cluster.local:3000"

  # Kubernetes namespace for Demon components
  namespace: demon-system

  # Persistent storage configuration
  persistence:
    enabled: true
    storageClass: local-path  # Default k3s storage class
    size: 10Gi

  # Optional: use a pre-built bundle for advanced configuration
  # bundle: "lib://demon-stack/v1.0.0"

# Secret management configuration
secrets:
  provider: env  # Options: 'env' or 'vault'

  # Environment variable provider configuration
  # Maps secret keys (as they'll appear in the K8s Secret) to environment variable names
  env:
    github_token: GITHUB_TOKEN         # Will read from $GITHUB_TOKEN env var
    admin_token: ADMIN_TOKEN           # Will read from $ADMIN_TOKEN env var
    database_url: DATABASE_URL         # Will read from $DATABASE_URL env var
    nats_password: NATS_PASSWORD       # Will read from $NATS_PASSWORD env var
    jwt_secret: JWT_SECRET             # Will read from $JWT_SECRET env var

  # Vault provider configuration (uncomment and configure if using vault)
  # vault:
  #   address: "https://vault.example.com:8200"  # Optional, defaults to $VAULT_ADDR
  #   role: "demon-bootstrap"                    # Optional, for Kubernetes auth
  #   path: "secret/demon/config"                # Path to secrets in Vault
  #   authMethod: "token"                        # Options: 'token' (default), 'kubernetes'
  # Note: When using token auth, set VAULT_TOKEN environment variable

# Optional add-ons for monitoring and observability
addons:
  # Monitoring stack with Prometheus and Grafana
  - name: monitoring
    enabled: false
    config:
      # Prometheus configuration
      prometheusRetention: "15d"        # How long to retain metrics
      prometheusStorageSize: "10Gi"     # Storage size for Prometheus data

      # Grafana configuration
      grafanaAdminPassword: "admin"     # Change this in production!

  # Example of a disabled add-on
  # - name: operational
  #   enabled: false

# Networking configuration
networking:
  # Ingress configuration for external access
  ingress:
    enabled: false                     # Enable ingress for Operate UI and Runtime API
    hostname: ui.example.com           # Hostname for the ingress (required if enabled)
    ingressClass: nginx                # Ingress class (optional, e.g., nginx, traefik)
    # annotations:                     # Optional annotations for the ingress
    #   nginx.ingress.kubernetes.io/rewrite-target: /
    #   nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      enabled: false                   # Enable TLS termination
      secretName: demon-tls            # Secret name containing TLS certificate

  # Service mesh configuration (Istio support)
  serviceMesh:
    enabled: false                     # Enable service mesh sidecar injection


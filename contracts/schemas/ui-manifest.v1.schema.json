{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://demon.dev/schemas/ui-manifest.v1.schema.json",
  "title": "Demon UI Manifest (v1)",
  "description": "UI card definitions for rendering ritual run results in Operate UI. Can be embedded in App Packs or distributed standalone.",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "apiVersion": {
      "type": "string",
      "const": "demon.io/v1",
      "description": "API version for the UI Manifest schema."
    },
    "kind": {
      "type": "string",
      "const": "UIManifest",
      "description": "Identifies this as a UI manifest."
    },
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "description": "Metadata about this UI manifest.",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9]+(?:[._-][a-z0-9]+)*$",
          "description": "Unique name for this UI manifest."
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+(?:-[A-Za-z0-9.-]+)?$",
          "description": "Semantic version of this manifest."
        },
        "displayName": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable display name."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Optional description of this manifest's purpose."
        }
      },
      "required": ["name", "version"]
    },
    "cards": {
      "type": "array",
      "description": "Card definitions for rendering run results.",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/cardDefinition"
      }
    }
  },
  "required": ["apiVersion", "kind", "metadata", "cards"],
  "$defs": {
    "cardDefinition": {
      "type": "object",
      "additionalProperties": false,
      "description": "Definition of a single UI card.",
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9]+(?:[._-][a-z0-9]+)*$",
          "description": "Unique identifier for this card within the manifest."
        },
        "kind": {
          "type": "string",
          "enum": ["result-envelope", "fields-table", "markdown-view", "json-viewer"],
          "description": "Card renderer type. Determines how the card displays data."
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Display title shown in the card header."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Optional description explaining the card's purpose."
        },
        "match": {
          "type": "object",
          "additionalProperties": false,
          "description": "Rules for when this card applies to a run.",
          "properties": {
            "rituals": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[a-z0-9]+(?:[._-][a-z0-9]+)*$"
              },
              "minItems": 1,
              "description": "Ritual names this card matches. Card displays only for runs of these rituals."
            },
            "tags": {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "description": "Optional tag filters. Card displays only for runs with these tags."
            }
          },
          "required": ["rituals"]
        },
        "config": {
          "type": "object",
          "description": "Card-specific configuration. Shape depends on the card kind."
        }
      },
      "required": ["id", "kind", "match"],
      "allOf": [
        {
          "if": {
            "properties": {
              "kind": {
                "const": "result-envelope"
              }
            }
          },
          "then": {
            "properties": {
              "config": {
                "$ref": "#/$defs/resultEnvelopeConfig"
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "kind": {
                "const": "fields-table"
              }
            }
          },
          "then": {
            "properties": {
              "config": {
                "$ref": "#/$defs/fieldsTableConfig"
              }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": {
              "kind": {
                "const": "markdown-view"
              }
            }
          },
          "then": {
            "properties": {
              "config": {
                "$ref": "#/$defs/markdownViewConfig"
              }
            },
            "required": ["config"]
          }
        },
        {
          "if": {
            "properties": {
              "kind": {
                "const": "json-viewer"
              }
            }
          },
          "then": {
            "properties": {
              "config": {
                "$ref": "#/$defs/jsonViewerConfig"
              }
            }
          }
        }
      ]
    },
    "resultEnvelopeConfig": {
      "type": "object",
      "additionalProperties": false,
      "description": "Configuration for result-envelope cards. Displays status badges, duration, and markdown content from run results.",
      "properties": {
        "statusPath": {
          "type": "string",
          "minLength": 1,
          "description": "JSON path to status field in envelope (e.g., 'result.success'). Renders as status badge."
        },
        "durationPath": {
          "type": "string",
          "minLength": 1,
          "description": "JSON path to duration field (e.g., 'metrics.duration.total_ms')."
        },
        "markdownPath": {
          "type": "string",
          "minLength": 1,
          "description": "JSON path to markdown content (e.g., 'diagnostics[0].message'). Rendered as formatted markdown."
        },
        "showTimestamp": {
          "type": "boolean",
          "default": true,
          "description": "Whether to display the run timestamp."
        }
      }
    },
    "fieldsTableConfig": {
      "type": "object",
      "additionalProperties": false,
      "description": "Configuration for fields-table cards. Displays structured key-value pairs from envelope data.",
      "properties": {
        "fields": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "label": {
                "type": "string",
                "minLength": 1,
                "description": "Display label for this field."
              },
              "path": {
                "type": "string",
                "minLength": 1,
                "description": "JSON path to extract value from envelope (e.g., 'outputs.result.data.message')."
              },
              "format": {
                "type": "string",
                "enum": ["text", "code", "timestamp", "duration", "badge"],
                "default": "text",
                "description": "How to format the field value for display."
              }
            },
            "required": ["label", "path"]
          },
          "description": "List of fields to display in the table."
        },
        "sortable": {
          "type": "boolean",
          "default": false,
          "description": "Whether to allow sorting by field values."
        }
      },
      "required": ["fields"]
    },
    "markdownViewConfig": {
      "type": "object",
      "additionalProperties": false,
      "description": "Configuration for markdown-view cards. Renders markdown content from envelope data.",
      "properties": {
        "contentPath": {
          "type": "string",
          "minLength": 1,
          "description": "JSON path to markdown content in envelope (e.g., 'outputs.report')."
        },
        "sanitize": {
          "type": "boolean",
          "default": true,
          "description": "Whether to sanitize HTML in rendered markdown."
        },
        "maxHeight": {
          "type": "string",
          "pattern": "^\\d+(px|rem|em|vh)$",
          "description": "Optional max height for scrollable content (e.g., '400px')."
        }
      },
      "required": ["contentPath"]
    },
    "jsonViewerConfig": {
      "type": "object",
      "additionalProperties": false,
      "description": "Configuration for json-viewer cards. Displays JSON data in an expandable tree view.",
      "properties": {
        "rootPath": {
          "type": "string",
          "minLength": 1,
          "description": "JSON path to data to display (e.g., 'outputs'). Defaults to entire envelope."
        },
        "expandDepth": {
          "type": "integer",
          "minimum": 0,
          "maximum": 10,
          "default": 2,
          "description": "Initial depth to expand in the tree view."
        },
        "highlightPaths": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "JSON paths to highlight in the tree (e.g., ['result.success', 'diagnostics'])."
        }
      }
    }
  }
}
